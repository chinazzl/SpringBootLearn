<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.template.mapper.TcmdbQueryMapper">

    <select id="getCmdbAfterFilter" resultType="string">
        WITH T AS (
        select target, listagg(tag_key, ',') within group(order by tag_key) as tags
        from T_CMDB_INFO
        WHERE 1 = 1
        <foreach collection="tagFilters" item="tagFilter" open="AND (" separator="OR" close=")">
            (TAG_KEY =#{tagFilter.tagKey} AND TAG_VALUE = #{tagFilter.tagValue})
        </foreach>
        group by target)
        SELECT A.target
        FROM
        (SELECT ROWNUM RN , target from T where t.tags in
        <foreach collection="tagKeyCombine" item="tag" open="(" separator="," close=")">
            #{tag}
        </foreach>
        AND ROWNUM &lt;= #{page.pageSize} ) A
        WHERE A.RN &gt;= #{page.pageNumber}
    </select>

    <select id="getCmdbInfo" resultType="org.template.dto.TCmdbInfo">
        SELECT t.valueText as valueText , T.TARGET as target, T.TARGETID AS TARGETID, T.TAG_KEY AS TARGETKEY, T.VALUE_TYPE AS VALUETYPE
        FROM (
        <foreach collection="queryTags" item="tag" separator="UNION ALL ">
            <if test="valueType == 'SIMPLE_TEXT'.toString()">
                SELECT TARGETID, TAG_KEY, TAG_VALUE AS valueText, TARGET, VALUE_TYPE FROM T_CMDB_INFO WHERE TAG_KEY = #{tag}
            </if>
            <if test="valueType == 'STD_CODE'.toString()">
                SELECT TARGETID, TAG_KEY, STD.VALUE_DESC AS valueText, TARGET ,VALUE_TYPE
                FROM T_CMDB_INFO TCMD INNER JOIN T_STD_CODE STD
                ON TCMD.TARGETID = STD.TAG_ID AND TCMD.TAG_VALUE = STD.VALUE_CODE
                WHERE TCMD.TAG_KEY = #{tag}
            </if>
        </foreach>
        ) T WHERE T.TARGET IN
        <foreach collection="targets" item="target" open="(" close=")" separator=",">
            #{target}
        </foreach>
    </select>
</mapper>